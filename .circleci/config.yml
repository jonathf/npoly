version-tags: &version-tags
    tags:
        only: /v\d+\.\d+\.\d+(-(alpha|beta|rc|dev|post)\d+)?/

version: 2.1
jobs:
    test-37:
        docker:
            - image: circleci/python:3.7.10
              auth:
                username: jonathf
                password: $DOCKERHUB_PASSWORD
        steps:
            - checkout
            - restore_cache:
                keys:
                    - py37-{{ checksum "requirements-dev.txt"}}
                    - py37-
            - run:
                name: "Installation"
                command: |
                    python3 -m venv venv
                    source venv/bin/activate
                    pip install -U pip
                    pip install .[dev]
            - save_cache:
                key: py37-{{ checksum "requirements-dev.txt"}}
                paths:
                    - venv
            - run:
                name: "Run tests"
                command: |
                    source venv/bin/activate
                    coverage run --source numpoly/ --module pytest --doctest-modules numpoly/ test/ docs/*.rst README.rst
            - run:
                name: "Report home"
                command: |
                    source venv/bin/activate
                    codecov
                    coverage report --show-missing
    test-310:
        docker:
            - image: circleci/python:3.10.1
              auth:
                username: jonathf
                password: $DOCKERHUB_PASSWORD
        steps:
            - checkout
            - restore_cache:
                keys:
                    - py310-{{ checksum "requirements-dev.txt"}}
                    - py310-
            - run:
                name: "Installation"
                command: |
                    python3 -m venv venv
                    source venv/bin/activate
                    pip install -U pip
                    pip install -r requirements-dev.txt
                    pip install .[dev]
            - save_cache:
                key: py310-{{ checksum "requirements-dev.txt"}}
                paths:
                    - venv
            - run:
                name: "Run pylint"
                command: |
                    source venv/bin/activate
                    pylint --rcfile=.pylintrc -E numpoly
            - run:
                name: "Run pydocstyle"
                command: |
                    source venv/bin/activate
                    pydocstyle --ignore=D202,D203,D212 numpoly
            - run:
                name: "Run black"
                command: |
                    source venv/bin/activate
                    black --check numpoly
            - run:
                name: "Run Sphinx build"
                command: |
                    source venv/bin/activate
                    sphinx-build docs/ docs/.build -b html -v --color -T -W --keep-going
    deploy:
        docker:
            - image: circleci/python:3.10.1
              auth:
                username: jonathf
                password: $DOCKERHUB_PASSWORD
        steps:
            - checkout
            - restore_cache:
                keys:
                    - py310-{{ checksum "requirements-dev.txt"}}
            - run:
                name: "Verify tag version"
                command: |
                    PROJECT_TAG=$(cat pyproject.toml \
                        | grep 'version\s*=' \
                        | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+\(-[a-z0-9]\+\)\{0,1\}')
                    echo "$CIRCLE_TAG == v$PROJECT_TAG"
                    test "$CIRCLE_TAG" = "v$PROJECT_TAG"
            - run:
                name: "Publish to PyPI"
                command: |
                    source venv/bin/activate
                    pip install twine build
                    python -m build
                    twine upload -u jonathf -p $PYPI_PASSWORD --non-interactive dist/*

workflows:
    version: 2.1
    workflow:
        jobs:
            - test-37:
                filters:
                    <<: *version-tags
            - test-310:
                filters:
                    <<: *version-tags
            - deploy:
                requires:
                    - test-37
                    - test-310
                filters:
                    <<: *version-tags
                    branches:
                        ignore: /.*/
